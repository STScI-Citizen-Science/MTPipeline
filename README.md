HST Moving Tartget Pipeline
===========================

The Hubble Space Telescope (HST) Moving Target Pipeline (MTP) is an image processing pipeline specifically designed for to unique processing challenges of solar system ("moving target") data. 

The pipeline take as its input FITS (Flexible Image Transport System) images and produces the following outputs. The outputs and processing steps are described in detail further in this document.

 - Reprocessed FITS files
 - Dyanmically scaled PNG preview images
 - A database of expected ephemerides for targets with known moons.

The pipeline is compatible with images from the following active and legacy HST cameras: 

 - Advanced Camera for Surverys (ACS):
  - High Resolution Channel (HRC)
  - Solar Blind Channel (SBC)
  - Wide Field Channel (WFC)
 - Wide Field Camera 3 (WFC3): 
  - IR
  - UVIS
 - Wide Field Plantary Camera 2 (WFPC2)

Overview
--------

MTPipeline is written in pure Python with some Python-wrapped C extensions. The pipeline can actually be viewed as two separate pipelines. One for producing the FITS and PNG files and a second for producing the ephemerides database. We will discuss both of these in order.

Imaging Pipeline
----------------

The steps for the imaging pipeline are:

 - Cosmic ray rejection
 - Drizzling
 - PNG Creation


### Cosmic Ray Rejection

Single-image cosmic ray rejection is performed using lacosmicsx, C. Mccully's python-wrapped C implementation of the Laplacian cosmic ray detection algorithm (LA Cosmics). This step produces a new FITS product named `filename_cr_c0m.fits`.  

lacosmicx: https://github.com/cmccully/lacosmicx
LA Cosmic: http://www.astro.yale.edu/dokkum/lacosmic/

### Drizzling

Single-image drizzling is performed using the AstroDrizzle tool in STScI's DrizzlePac software. This step takes both the original FITS file and the CR-rejected FITS output of the CR-rejection step. This step produces 2 outputs per input, a "wide" mode and a "center" mode that differ only in their output dimensions. Each camera has it's own unique configuration determined by the files in the `astrodrizzle_cfg` folder. Users can change the settings by editing those files.

DrizzlePac: http://www.stsci.edu/hst/HST_overview/drizzlepac

--- An aside on CTE correction ---

### PNG Creation

The images are dynamically scaled using a custom algorithm developed for this project. 

--- Lots of images  ---

The PNG scaling is performed in matplotlib library with the `agg` backend and written using the Pillow fork of the Python Image Library (PIL).

Ephmerides Pipeline
-------------------

The ephmerides pipeline exists to help catalog the rich set of "incidental" observations that occur when observing an object with known moons. We do not attempt to automatically identify any other types of incidental observations such as asteroids. Finally, these ephemerides are predicted positions only, no validation of fidelity with the image is performed. The ephemerides are generated by sending target, date, and time information to the JPL HORIZONS system.

The steps for the ephemerides pipeline are:

 - Target name normalization
 - JPL Horizons query
 - Coordinate transformation (celestial to physical)

### Target Name Normalization

The first step in generating the ephemerides is normalizing the observer generated  target name in the FITS `TARGNAME` header keyword in a object name recognized by the JPL HORIZONS system. The `TARNAME` value is matched against the names in the `planets_and_moons.txt` file. Because the same target could be called `Jupiter`, `jupiter`, `jup`, `jup-io`, etc. this is essentially a string parsing problem. 

### JPL Horizons Query

We communicate with the JPL HORIZONS system using an undocumented CGI interface. We were explicitly given permission to use this interface by the JPL HORIZONS engineers. Please do not use this CGI without consulting with them as well. This query returns, the predicted RA, Dec, magnitude, and diameter of the object.

### Coordinate Transformation

The last step is to translate the HORIZONS RA and Dec information into the pixel space of the image. This is done using pixel scale, the reference pixel, and the pointing information from the header.

Installation
------------

### At STScI

### External Users

Installing the MT Pipeline outside of STScI has never been attempted. 

Use
---

--- add ---

Contacts
--------

**Alex C. Viana**  
Space Telescope Science Institute (STScI)  
http://acviana.github.com/  
viana [at] stsci [dot] edu  
alex [dot] costa [dot] viana [at] gmail [dot] com  
  
**Space Telescope Science Institute (STScI)**  
http://www.stsci.edu  
  
**CosmoQuest**  
http://cosmoquest.org/  

License
=======

Fast Cosmics is licensed under a 3-clause BSD style license:

Copyright (c) 2013, Space Telescope Science Institute.

All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

- Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
- Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
- Neither the name of Space Telescope Science Institute, CosmoQuest, nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.


