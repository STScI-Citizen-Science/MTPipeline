HST Moving Tartget Pipeline
===========================

The Hubble Space Telescope (HST) Moving Target Pipeline (MTP) is an image processing pipeline specifically designed for to unique processing challenges of solar system ("moving target") data. 

The pipeline take as its input FITS (Flexible Image Transport System) images and produces the following outputs. The outputs and processing steps are described in detail further in this document.

 - Reprocessed FITS files
 - Dyanmically scaled PNG preview images
 - A database of expected ephemerides for targets with known moons.

The pipeline is compatible with images from the following active and legacy HST cameras: 

 - Advanced Camera for Surverys (ACS):
  - High Resolution Channel (HRC)
  - Solar Blind Channel (SBC)
  - Wide Field Channel (WFC)
 - Wide Field Camera 3 (WFC3): 
  - IR
  - UVIS
 - Wide Field Plantary Camera 2 (WFPC2)

Overview
--------

MTPipeline is written in pure Python with some Python-wrapped C extensions. The pipeline can actually be viewed as two separate pipelines. One for producing the FITS and PNG files and a second for producing the ephemerides database. We will discuss both of these in order.

Imaging Pipeline
----------------

The steps for the imaging pipeline are:

 - Cosmic ray rejection
 - Drizzling
 - PNG Creation


### Cosmic Ray Rejection

Single-image cosmic ray rejection is performed using lacosmicsx, C. Mccully's python-wrapped C implementation of the Laplacian cosmic ray detection algorithm (LA Cosmics). This step produces a new FITS product named `filename_cr_c0m.fits`.  

lacosmicx: https://github.com/cmccully/lacosmicx
LA Cosmic: http://www.astro.yale.edu/dokkum/lacosmic/

### Drizzling

Single-image drizzling is performed using the AstroDrizzle tool in STScI's DrizzlePac software. This step takes both the original FITS file and the CR-rejected FITS output of the CR-rejection step. This step produces 2 outputs per input, a "wide" mode and a "center" mode that differ only in their output dimensions. Each camera has it's own unique configuration determined by the files in the `astrodrizzle_cfg` folder. Users can change the settings by editing those files.

DrizzlePac: http://www.stsci.edu/hst/HST_overview/drizzlepac

--- An aside on CTE correction ---

### PNG Creation

The images are dynamically scaled using a custom algorithm developed for this project. 

--- Lots of images  ---

The PNG scaling is performed in matplotlib library with the `agg` backend and written using the Pillow fork of the Python Image Library (PIL).

Ephmerides Pipeline
-------------------

The ephmerides pipeline exists to help catalog the rich set of "incidental" observations that occur when observing an object with known moons. We do not attempt to automatically identify any other types of incidental observations such as asteroids. Finally, these ephemerides are predicted positions only, no validation of fidelity with the image is performed. The ephemerides are generated by sending target, date, and time information to the JPL HORIZONS system.

The steps for the ephemerides pipeline are:

 - Target name normalization
 - JPL Horizons query
 - Coordinate transformation (celestial to physical)

### Target Name Normalization

The first step in generating the ephemerides is normalizing the observer generated  target name in the FITS `TARGNAME` header keyword in a object name recognized by the JPL HORIZONS system. The `TARNAME` value is matched against the names in the `planets_and_moons.txt` file. Because the same target could be called `Jupiter`, `jupiter`, `jup`, `jup-io`, etc. this is essentially a string parsing problem. 

### JPL Horizons Query

We communicate with the JPL HORIZONS system using an undocumented CGI interface. We were explicitly given permission to use this interface by the JPL HORIZONS engineers. Please do not use this CGI without consulting with them as well. This query returns, the predicted RA, Dec, magnitude, and diameter of the object.

### Coordinate Transformation

The last step is to translate the HORIZONS RA and Dec information into the pixel space of the image. This is done using pixel scale, the reference pixel, and the pointing information from the header.

Installation
------------

### At STScI

STScI provides many of the pipeline's external dependencies at various
locations on its filesystem. However, the accessibility of some of these
dependencies varies between the filesystems seen by the Institute's Macs and
 by the RedHat science cluster. Two different installation procedures are thus provided. 

#### On Macs:

The ssbx development distribution of Ureka is required. Install it following the
instructions [here](http://ssb.stsci.edu/ssb_software.shtml).

The AstroDrizzle step in the pipeline requires defining three variables in your pipeline. If you use bash,

    export uref=/grp/hst/cdbs/uref/
    export iref=/grp/hst/cdbs/iref/
    export jref=/grp/hst/cdbs/jref/

These can be added to your `.bashrc`, along with the `ur_setup` command above. 

If you use tcsh, add these to your `.cshrc`. 

    setenv uref /grp/hst/cdbs/uref/
    setenv iref /grp/hst/cdbs/iref/
    setenv jref /grp/hst/cdbs/jref/

Don't forget to start a new terminal session if you are adding these to your terminal profile files. Now, cd to `MTPipeline/`, and run

`python setup.py develop`

This takes advantage of Python's `setuptools` to install or locate the
remaining external dependencies. If everything goes well, it will do two things:

1. Build the C components of `lacosmicx`, for which it needs the `cfitsio`
   library. The path to this library on the institute's filesystem is
   hard-coded in `setup.py`. If you are seeing errors involving '.h` files, then the
   location of the `cfitsio` library has changed, and you should see `setup.py`
   for more information.

2. Install any remaning python modules, such as Pillow, pymysql, psuitl.

This should suffice to install the pipeline in-place on Macs.

#### On the RedHat Science Cluster

The ssbx development version of Ureka is already installed on science3 and
science4. Use it by adding the following to your `.setenv`:

    # If a local Ureka installation is active (i.e. ur_setup has been executed)
    # do nothing. Otherwise load SSB's build in /usr/stsci
    if ( ! $?UR_DIR ) then
        if ( -f /usr/stsci/envconfig.mac/cshrc ) then
            source /usr/stsci/envconfig.mac/cshrc
            ssbx
        endif
    endif

Also in `.setenv`, define the variables

    setenv uref /grp/hst/cdbs/uref/
    setenv iref /grp/hst/cdbs/iref/
    setenv jref /grp/hst/cdbs/jref/

Make sure to restart your terminal session after making these changes.

As this version of Ureka is read-only, however, the pipeline's external modules
will need a separate environment to install into. Following the instructions
[here](http://ssb.stsci.edu/customize_python_environment.shtml), to set up and
activate a virtual environment for this purpose.

`setup.py` is currently configured to install on a Mac connected to the
institute filesystem. The science cluster sees a slightly different filesyste.
Edit `setup.py` to change the paths

    cfitslib_path = '/sw/include'
    cfitsinc_path = '/sw/lib' 

to

    cfitslib_path = '/usr/include'
    cfitsinc_path = '/usr/lib' 

Having done this, run

    python setup.py develop

The pipeline should be ready to run.

### External Users

While installing the pipeline outside the institute filesystem is entirely
possible, successfully running it faces hurdles. 

The main hinderance to running the pipeline outside of the the STScI filesystem
is the AstroDrizzle step. AstroDrizzle requires reference files, the path to
which is defined by the uref, iref, and jref environment variables. There are
more than a terabyte of reference files in total, and different referrences
will be required for the proper processing of different input images.

The AstroDrizzle step will run, however, so long as the paths described in the installation
guide are defined. If it is unable to find the appropriate reference files, AstroDrizzle will simply skip

The cosmic ray rejection and png creation should both be functional, however
(although the latter expects AstroDrizzle outputs). At minimum, the pipeline
requires a built cfitsio library and Python installation with NumPy. 

The pipeline has been successfully installed on Ubuntu virtual environments provided by Travis CI. The automated script for doing so can be found in `MTPipeline/.travis.yml`. Note that, at the moment, that script sets the `CPLUS_INCLUDE_PATH` and `LIBRARY_PATH`, and so it is not wisely used outside of a fresh virtual environment.

Use
---

The preferred interface for running the pipeline is through the terminal. From the top level directory `MTPipeline/`, the pipelin can be run by

    python scripts/production/run_imaging_pipeline.py -filelist "path/to/

Contacts
--------

**Alex C. Viana**  
Space Telescope Science Institute (STScI)  
http://acviana.github.com/  
viana [at] stsci [dot] edu  
alex [dot] costa [dot] viana [at] gmail [dot] com  
  
**Space Telescope Science Institute (STScI)**  
http://www.stsci.edu  
  
**CosmoQuest**  
http://cosmoquest.org/  

License
=======

Fast Cosmics is licensed under a 3-clause BSD style license:

Copyright (c) 2013, Space Telescope Science Institute.

All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

- Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
- Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
- Neither the name of Space Telescope Science Institute, CosmoQuest, nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.


